---
- name: K3s Pre-Flight Preparation
  hosts: k3s_cluster
  become: true
  gather_facts: true

  tasks:
    # --- STAGE 1: SWAP REMOVAL ---
    - name: Stage 1 - Disable Swap Immediately
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Stage 2 - Remove Swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+.*)$'
        replace: '# \1'

    # --- STAGE 3: KERNEL MODULES ---
    - name: Stage 3 - Load Overlay and Br_netfilter
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    # --- STAGE 4: SYSCTL NETWORKING ---
    - name: Stage 4 - Enable IPv4 Forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: true
        state: present
        reload: true

    # --- STAGE 5: SYSTEM DEPENDENCIES ---
    - name: Stage 5 - Install Required K3s Utils
      apt:
        name:
          - curl
          - nfs-common
          - open-iscsi
        state: present
        update_cache: true

    # --- STAGE 6: ISCSI SERVICE ---
    - name: Stage 6 - Enable iSCSI for Longhorn/Storage
      systemd:
        name: iscsid
        enabled: true
        state: started